function asyncGeneratorStep(b,d,f,e,g,h,a){try{var c=b[h](a),i=c.value}catch(a){return void f(a)}c.done?d(i):Promise.resolve(i).then(e,g)}function _asyncToGenerator(b){return function(){var c=this,d=arguments;return new Promise(function(e,f){function g(a){asyncGeneratorStep(i,e,f,g,h,"next",a)}function h(a){asyncGeneratorStep(i,e,f,g,h,"throw",a)}var i=b.apply(c,d);g(void 0)})}}import{XMLParser}from"fast-xml-parser";import got from"got";import zlib from"zlib";import pLimit from"p-limit";import isGzip from"is-gzip";export default class Sitemapper{constructor(a){var b=a||{requestHeaders:{}};this.url=b.url,this.timeout=b.timeout||15e3,this.timeoutTable={},this.lastmod=b.lastmod||0,this.requestHeaders=b.requestHeaders,this.debug=b.debug,this.concurrency=b.concurrency||10,this.retries=b.retries||0,this.rejectUnauthorized=!1!==b.rejectUnauthorized,this.fields=b.fields||!1,this.proxyAgent=b.proxyAgent||{},this.exclusions=b.exclusions||[],this.signal=b.signal}fetch(){var a=arguments,b=this;return _asyncToGenerator(function*(){var c=0<a.length&&a[0]!==void 0?a[0]:b.url,d=1<a.length&&a[1]!==void 0?a[1]:{},e=d.signal||b.signal;if(e&&e.aborted)throw new Error("Request was aborted");var f={url:"",sites:[],errors:[]};b.debug&&b.lastmod&&console.debug("Using minimum lastmod value of ".concat(b.lastmod));try{f=yield b.crawl(c,0,e)}catch(a){if(b.debug&&console.error(a),"AbortError"===a.name||"Request was aborted"===a.message)throw a}return{url:c,sites:f.sites||[],errors:f.errors||[]}})()}static get timeout(){return this.timeout}static set timeout(a){this.timeout=a}static get lastmod(){return this.lastmod}static set lastmod(a){this.lastmod=a}static set url(a){this.url=a}static get url(){return this.url}static set debug(a){this.debug=a}static get debug(){return this.debug}parse(){var a=arguments,b=this;return _asyncToGenerator(function*(){var c=0<a.length&&a[0]!==void 0?a[0]:b.url,d=1<a.length&&a[1]!==void 0?a[1]:null;if(d&&d.aborted)throw new Error("Request was aborted");var e={method:"GET",resolveWithFullResponse:!0,gzip:!0,responseType:"buffer",headers:b.requestHeaders,https:{rejectUnauthorized:b.rejectUnauthorized},agent:b.proxyAgent};d&&(e.signal=d);try{var f=got.get(c,e);b.initializeTimeout(c,f,d);var g=yield f;if(!g||200!==g.statusCode)return clearTimeout(b.timeoutTable[c]),{error:g.error,data:g};var h=isGzip(g.rawBody)?yield b.decompressResponseBody(g.body):g.body;var i=new XMLParser({isArray:a=>["sitemap","url"].some(b=>b===a),removeNSPrefix:!0}),j=i.parse(h.toString());return{error:null,data:j}}catch(a){if(clearTimeout(b.timeoutTable[c]),"AbortError"===a.name||"Request was aborted"===a.message)throw a;return"CancelError"===a.name?{error:"Request timed out after ".concat(b.timeout," milliseconds for url: '").concat(c,"'"),data:a}:"HTTPError"===a.name?{error:"HTTP Error occurred: ".concat(a.message),data:a}:{error:"Error occurred: ".concat(a.name),data:a}}})()}initializeTimeout(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(this.timeoutTable[a]=setTimeout(()=>b.cancel(),this.timeout),c){var d=()=>{clearTimeout(this.timeoutTable[a]),b.cancel()};c.aborted?d():c.addEventListener("abort",d,{once:!0})}}crawl(a){var b=arguments,c=this;return _asyncToGenerator(function*(){var d=1<b.length&&b[1]!==void 0?b[1]:0,e=2<b.length&&b[2]!==void 0?b[2]:null;try{var{error:f,data:g}=yield c.parse(a,e);if(clearTimeout(c.timeoutTable[a]),f)return d<c.retries?(c.debug&&console.log("(Retry attempt: ".concat(d+1," / ").concat(c.retries,") ").concat(a," due to ").concat(g.name," on previous request")),c.crawl(a,d+1,e)):(c.debug&&console.error("Error occurred during \"crawl('".concat(a,"')\":\n\r Error: ").concat(f)),{sites:[],errors:[{type:g.name,message:f,url:a,retries:d}]});if(g&&g.urlset&&g.urlset.url){c.debug&&console.debug("Urlset found during \"crawl('".concat(a,"')\""));var h=Array.isArray(g.urlset.url)?g.urlset.url:[g.urlset.url],i=h.filter(a=>{if(0===c.lastmod)return!0;if(void 0===a.lastmod)return!1;var b=new Date(a.lastmod).getTime();return b>=c.lastmod}).filter(a=>!c.isExcluded(a.loc)).map(b=>{if(!c.fields)return b.loc;var d={};c.fields.sitemap&&(d.sitemap=a);for(var[e,f]of Object.entries(c.fields))f&&b[e]&&(d[e]=b[e]);return d});return{sites:i,errors:[]}}if(g&&g.sitemapindex){c.debug&&console.debug("Additional sitemap found during \"crawl('".concat(a,"')\""));var j=g.sitemapindex.sitemap.map(a=>a.loc).filter(a=>!c.isExcluded(a)),k=pLimit(c.concurrency),l=j.map(a=>k(()=>c.crawl(a,0,e))),m=yield Promise.all(l),n=m.filter(a=>0===a.errors.length).reduce((a,b)=>{var{sites:c}=b;return[...a,...c]},[]),o=m.filter(a=>0!==a.errors.length).reduce((a,b)=>{var{errors:c}=b;return[...a,...c]},[]);return{sites:n,errors:o}}return d<c.retries?(c.debug&&console.log("(Retry attempt: ".concat(d+1," / ").concat(c.retries,") ").concat(a," due to ").concat(g.name," on previous request")),c.crawl(a,d+1,e)):(c.debug&&console.error("Unknown state during \"crawl('".concat(a,")'\":"),f,g),{sites:[],errors:[{url:a,type:g.name||"UnknownStateError",message:"An unknown error occurred.",retries:d}]})}catch(a){if(c.debug&&c.debug&&console.error(a),"AbortError"===a.name||"Request was aborted"===a.message)throw a}})()}getSites(){var a=arguments,b=this;return _asyncToGenerator(function*(){var c=0<a.length&&a[0]!==void 0?a[0]:b.url,d=1<a.length?a[1]:void 0;console.warn("\r\nWarning:","function .getSites() is deprecated, please use the function .fetch()\r\n");var e={},f=[];try{var g=yield b.fetch(c);f=g.sites}catch(a){e=a}return d(e,f)})()}decompressResponseBody(a){return _asyncToGenerator(function*(){return yield new Promise((b,c)=>{var d=Buffer.from(a);zlib.gunzip(d,(a,d)=>{a?c(a):b(d)})})})()}isExcluded(a){return 0!==this.exclusions.length&&this.exclusions.some(b=>b.test(a))}}
//# sourceMappingURL=sitemapper.js.map